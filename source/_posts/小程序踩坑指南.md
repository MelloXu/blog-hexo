---
title: 小程序踩坑指南
date: 2018/09/17
tags: 小程序 前端 开发 微信小程序
---

<!--more-->

小程序开发过程中遇到的一些问题和总结。

*   [工程目录与规划](#工程目录与规划)
*   [开发与调试](#开发与调试)
    *   [语言](#语言)
    *   [工具](#工具)
    *   [mock数据](#mock数据)
    *   [链接正式数据](#链接正式数据)
    *   [css不支持的语法](#css不支持的语法)
    *   [js不支持的语法](#js不支持的语法)
    *   [map的限制](#map的限制)
    *   [用户权限调用的规范](#用户权限调用的规范)
    *   [难点踩坑经验](#难点踩坑经验)
*   [发布](#发布)
    *   [周期](#周期)
    *   [限制](#限制)
*   [页面链接跳转](#页面链接跳转)
    *   [navigation堆栈的限制](#navigation堆栈的限制)
    *   [路径的规划梳理](#路径的规划梳理)
*   [设计上的不可行](#设计上的不可行)
*   [后端要注意的事项](#后端要注意的事项)


<span style="font-size: 18px; font-weight: 900; color: #66ccff;">前端开发（普及知识/梳理工作流/总结踩坑经验）</span>

### 工程目录与规划 ###

首先，开始小程序的开发前，你需要一个微信公众平台的[账号](https://mp.weixin.qq.com/),一个AppID(小程序ID)，然后就可以初步进行小程序的正式开发了。

**工程目录如下**

![根目录](https://raw.githubusercontent.com/yukinya/git_resource/master/images/20180917-小程序.png)

pages目录下为项目的每个页面，其中components为组件，resources中为一些文件资源（建议图片尽量使用在线图片，小程序总体限制大小为2MB），utils下为工具类的js和一些插件，app.js为小程序的入口，可以在其中设置全局项，app.json可以设置小程序的配置项，app.wxss可以设置全局样式。

**页面目录**

![页面目录](https://raw.githubusercontent.com/yukinya/git_resource/master/images/20180917-小程序-2.png)

pages文件夹中，每个页面中由四个文件构成，四个文件只负责本页面，不影响其他页面。wxml中是页面的结构,wxss是页面的样式（只影响本页面，基于此特性可以直接覆盖全局样式而不影响原样式） js文件中为本页面的页面数据渲染和操作等，json文件可以设置当前页面的设置项比如disableScroll可以禁止本页面滚动以及加载自定义组件。

**开发思路**

1. 在开发页面的时候，我们应该先确定页面有哪些页面组成和页面与页面之间的关系，防止页面跳转过深，小程序的跳转可以粗略分为不关闭当前页面的跳转以及关闭当前页面的跳转，在不关闭当前页面的情况下，目前页面层级最多为10级。

2. 其次要想好哪些部分可以提取出来，比如公用的header和footer，以及各种自定义通用组件，这样会节省大量时间。

3. 动手前先看一遍页面需要哪些数据，和后端粗略商定一下需要的数据格式。

4. 确定哪些设计不可实现，及时沟通。

### 开发与调试 ###

小程序的开发和调试都要用到[微信开发者工具](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)。

开发和调试要注意的点： 

1. 开发目录资源不要超过2M，否则无法进行实机调试，图片等资源可以先开一个本地服务器引用。
2. 开发中一定要实时进行实机调试，开发工具的呈现效果有时与移动设备效果相反，小程序的实机调试分为两种，远程调试和预览调试，调试时会上传到微信的服务器，所以注意每次修改代码后都要重新调试。
3. 小程序的背景图片不支持本地图片，所有引用图片尽量使用在线地址。
4. 小程序的开发工具只能显示接口请求，不能显示图片等资源的加载。
5. 需要在小程序的开发设置中配置合法域名，否则预览时可能无法获取所需数据。

#### 语言 ####

小程序使用的语言和编写html的不同点： 

wxml中，view类似于div的作用，小程序中不能使用html中常见的p,span等dom元素，取而代之的是`view,scroll-view`等视图容器和`text、icon、rich-text`等基础内容，小程序中没有html和body的概念，视图根层级为`<page></page>`，在wxml文件中不作为代码层。

wxss中，语法与css没有太多差异，可以使用小程序的特有单位rpx，会根据设备屏幕宽度自动换算px单位

js与vue类似，有各个页面事件（加载，显示，卸载）

json文件中可以配置当前页面的各个选项及调用组件

#### 工具 ####

小程序的开发工具为为微信开发者工具,目前有两种开发方式，直接在开发工具中编写代码或用vue来生成小程序代码，vue生成代码的开发框架有美团的[mpvue](https://github.com/Meituan-Dianping/mpvue)和腾讯的[wepy](https://github.com/Tencent/wepy)。

#### mock数据 ####

根据设计稿页面定义接口和所需数据，和后端定义数据接口字段，可选用在线mock接口如[Yapi](https://yapi.ymfe.org/)或通过本地json来mock数据，

#### 链接正式数据 ####

和后端定义好接口字段，在开发设置中设置合法域名，接口应为https（对应正式发布），小程序同时仅可有5个request请求，默认都为异步请求，需要同步请求需要自己封装。

#### css不支持的语法 ####

与css语法基本无异，圆角属性在iOS上有几率出现过渡效果bug

#### js不支持的语法 ####

除不支持DOM操作外，基本没有不支持的原生JS语法

#### map的限制 ####

map必须要定义一个初始经纬度用来初始化，map的markers的iconPath支持项目目录的相对路径和临时路径以及网络图片(基础库2.3.0开始)

map可以用includePoints方法缩放地图使传入坐标点在一屏内显示，在IOS有误差，需要手动调整。

map等原生组件上，不能覆盖普通元素，z-index无效，需使用cover-view或者cover-image来覆盖在其上，cover-view中无法嵌套其他普通元素。

#### 用户权限调用的规范 ####

2018.05.01，微信官方发表公告称05.01之后审核通过的小程序，无法在进入小程序时触发主动弹窗授权。需要用`<button open-type="getUserInfo"></button>`授权按钮来让用户主动触发授权。

用按钮触发的授权窗口，用户拒绝后可以无限次通过按钮继续触发，2018.05.01之前已经审核通过的小程序可以主动弹出授权窗口，但如果用户已拒绝授权，则短期内不会出现弹窗，而是直接进入接口 fail 回调。两种方法各有利弊。 

如果要获取用户信息，在设计时应该考虑保留一个让用户触发授权的按钮。

除了用户信息的权限之外，微信还会调用功能权限，比如保存图片和调用位置信息，拒绝之后短时间无法再次调用，可以考虑提示用户并打开权限设置界面，引导用户主动授权，以免造成不好的用户体验。

#### 难点踩坑经验 ####

开发前一定要规划好页面结构和组件，将会大大节省开发时间，可行的情况下在开发前和后端约定接口结构和参数字段等，节省真实数据的替换时间。

小程序的音频播放分为两种，一种是拥有同时多个音频播放能力但没有后台播放能力的`wx.createInnerAudioContext()`和全局只有一个音频但拥有后台播放能力的`wx.getBackgroundAudioManager()`，在开发前要根据项目的需求来更改避免后期做大改动。

尽量不要在一处地方进行过多授权操作，可以考虑分散在多处进行授权。

IOS在关闭定位服务的时候无法获取当前位置，应提示用户打开定位服务

富文本组件不支持html转义符，应直接使用符号或选用富文本插件，原生富文本组件只支持class样式，标签样式和id样式不支持。

swiper组件的前后偏移只支持px和rpx单位。

小程序的所有视图更新都必须通过setData()方法触发，直接更改数据无法触发更新，所以在调试界面更改wxml代码也是无效的, 对于数组可以封装一个方法用来直接更新视图。

组件内的样式不受全局样式的影响，所以有些组件内需要使用全局样式时需要再单独写一遍。

`"disableScroll"`设置在安卓上无效 (设置为 true 则页面整体不能上下滚动；只在页面配置中有效)

可以通过include的方式减少组件代码的重复，使用一个wxml实现多个组件[参考文章](https://mp.weixin.qq.com/s/wukb02PaZfRXzhqHzfGMBQ)

### 发布 ###

#### 周期 ####

小程序的发布分为开发版本（体验版）审核版本和线上版本

开发版可以随时上传代码来查看体验版页面，提交代码到审核版后，视修改内容经过一段时间后会变为线上版本。通常第一次提交需要1天左右的时间。

#### 限制 ####

小程序打包大小不能超过2M 

发布到体验版的小程序，数据接口需要为https且要在合法域名中设置，背景图片需要为网络图片，提交为线上版本审核需要时间，应修改好一部分后再提交，通常样式的修改审核时间为1H左右，涉及到增加页面，改动逻辑等可能审核时间会长一些。

<span style="font-size: 18px; font-weight: 900; color: #66ccff;">设计（提需求/注意事项/普及相关知识点）</span>

### 页面链接跳转 ###

#### navigation堆栈的限制 ####
小程序的页面跳转主要分为两种 打开新页面	和 页面重定向

其中打开新页面`wx.navigateTo`会不关闭当前页面并在当前页面之上打开一个新页面，小程序的页面栈最多为10层，超出10层后，再次执行`wx.navigateTo`无反应。所以应当在设计的时候就考虑到页面的层级深度以及如何优化

### 设计上的不可行 ###

过深的页面层级，开发经验太少，其他部分暂未发现

<span style="font-size: 18px; font-weight: 900; color: #66ccff;">后端开发（提需求/注意事项/普及相关知识点）</span>

### 后端要注意的事项 ###

开发前尽量和前端确定好每个页面大致需求的数据，数据格式，字段。
在一个页面中最好不用使用过多的接口，可能影响页面速度。

